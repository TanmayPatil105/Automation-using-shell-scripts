#!/bin/bash

COLS=$(tput cols)
GREEN='\e[32m%s\n'
ENDCOLOR="\e[0m"

# Displays wifi usage
function command_help() {    
	cat /usr/share/wifi/help.txt
	exit $?
}

# Displays list of available networks
function command_list() {
	if [ $(nmcli radio wifi) == "enabled" ]
	then
		if [ `expr $COLS` -lt  110 ]
		then
			resize -s 24 110 > /dev/null
		fi
		nmcli dev wifi list > /tmp/wifi.txt
		cat /tmp/wifi.txt
		rm /tmp/wifi.txt
	else 
		echo "Wifi is disabled"

	fi
	exit $?
}

#Connects to given SSID
function command_connect() {
    nmcli dev wifi connect $2
	exit $?
}

# Turns wifi on
function command_on() {
	if [ $(nmcli radio wifi) == "enabled" ]
	then
		echo "Wifi is already enabled"
	else 
		nmcli radio wifi on
		echo "Turned ON WIFI"
	fi
	exit $?
}

# Turns wifi off
function command_off() {
    if [ $(nmcli radio wifi) == "disabled" ]
	then 
		echo "Wifi is already disabled"
	else 
		nmcli radio wifi off
		echo "Turned OFF WIFI"
	fi
	exit $?
}

# Displays wifi or Hotspot password
function command_pass() {
    if [ $(nmcli radio wifi) == "disabled" ]
    then
		echo "Wifi is already disabled"
    else
        nmcli dev wifi show-password
	fi
	exit $?
}

# Displays all saved wifi networks
function command_saved() {
	file=()
	while IFS= read -r line; do
   		 file+=( "$line" )
	done < <(cd /etc/NetworkManager/system-connections ;ls)

	i=0
	list=()
	while IFS= read -r line; do
                 list+=( "$line" )
    done < <(while [ $i -lt  ${#file[@]} ]
			do
				echo  "${file[$i]}" | cut -d'.' -f 1
				i=`expr $i + 1`
    		done) 

	printf $GREEN "${list[@]}"
	echo -ne "$ENDCOLOR"
	exit $?
}

# Turns Hotspot on
function command_hotspot() {
	if [ $# == 1 ]
	then
		if [ $(nmcli radio wifi) == "disabled" ]
		then
			echo "Wifi is turned off!"
			echo "Turn ON wifi"
			echo "Try \"wifi --help or -h\" for help"
			exit $?
		fi
		timeout 5s echo "Setting up Hotspot..."
		nmcli con up Hotspot > /dev/null
		echo "Hotspot is Turned ON"
		timeout 3s echo "Showing Password..." > /dev/null
		nmcli dev wifi show-password
		exit $?
	fi
	if [ $# == 2 -a $2 == "off" ]
	then	
		if [ $(nmcli radio wifi) == "disabled" ]
		then
			echo "Hotspot is already disabled"
			exit $?
		fi
		timeout 3s echo "Turning Hotspot OFF..."
		nmcli con down Hotspot > /dev/null
		echo "Hotspot is Turned OFF"
		exit $?
	fi

	exit $?
}

# Forget a wifi network
function command_forget() {
	sudo rm /etc/NetworkManager/system-connections/$2.nmconnection
	exit $?
}

if [ $# == 0 ]
then
	echo "Try wifi --help or -h for more information"
	exit $?
fi

if [ $1 == "--help" -o $1 == "-h" ]
then
    command_help # noreturn
fi

command="command_$1"
if [[ $(type -t $command) != "function" ]]; then
    echo -e "wifi: '$1' is not a command\n"    
    echo "Run 'wifi --help' or 'wifi -h' to see a list of wifi commands"    
    exit $?
fi

eval "$command $(echo "$@")"
